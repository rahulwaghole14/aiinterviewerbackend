<!DOCTYPE html>
<html>
<head>
    <title>Windows Microphone Test</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        #meter { width: 500px; height: 100px; background: #eee; margin: 20px 0; position: relative; }
        #bar { height: 100%; background: linear-gradient(to right, green, yellow, red); width: 0%; transition: width 0.05s; }
        #level { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: bold; }
        button { padding: 15px 30px; font-size: 18px; margin: 10px; cursor: pointer; }
        .good { background: #d4edda; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .bad { background: #f8d7da; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üé§ Windows Microphone Test</h1>
    <p><strong>This will test if your microphone is actually capturing audio.</strong></p>
    
    <button onclick="startTest()" style="background: #28a745; color: white; border: none;">‚ñ∂ Start Test</button>
    <button onclick="stopTest()" style="background: #dc3545; color: white; border: none;">‚èπ Stop Test</button>
    
    <h2>Audio Level Meter:</h2>
    <div id="meter">
        <div id="bar"></div>
        <div id="level">0%</div>
    </div>
    
    <div id="status" style="font-size: 18px; padding: 15px; background: #f0f0f0; border-radius: 5px;"></div>
    
    <h3>Diagnostic Info:</h3>
    <div id="info" style="font-family: monospace; background: #f5f5f5; padding: 15px; border-radius: 5px;"></div>

    <script>
        let stream = null;
        let audioContext = null;
        let analyser = null;
        let processor = null;
        let source = null;
        let animationId = null;
        let maxRMS = 0;
        let totalPackets = 0;
        let soundPackets = 0;

        async function startTest() {
            try {
                document.getElementById('status').innerHTML = 'üé§ Requesting microphone access...';
                
                // Request ALL available microphones
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(d => d.kind === 'audioinput');
                
                let info = '<strong>Available Microphones:</strong><br>';
                audioInputs.forEach((device, i) => {
                    info += `${i + 1}. ${device.label || 'Microphone ' + (i + 1)}<br>`;
                });
                document.getElementById('info').innerHTML = info;
                
                // Get default microphone
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                const track = stream.getAudioTracks()[0];
                const settings = track.getSettings();
                
                info += '<br><strong>Active Microphone:</strong><br>';
                info += `Label: ${track.label}<br>`;
                info += `Settings: ${JSON.stringify(settings, null, 2)}<br>`;
                document.getElementById('info').innerHTML = info;
                
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                source = audioContext.createMediaStreamSource(stream);
                
                // Create analyser
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                
                // Create processor
                processor = audioContext.createScriptProcessor(4096, 2, 1);
                
                processor.onaudioprocess = (e) => {
                    totalPackets++;
                    
                    // Get audio data
                    const left = e.inputBuffer.getChannelData(0);
                    const right = e.inputBuffer.numberOfChannels > 1 ? e.inputBuffer.getChannelData(1) : left;
                    
                    // Calculate RMS
                    let sum = 0;
                    for (let i = 0; i < left.length; i++) {
                        const mono = (left[i] + right[i]) / 2;
                        sum += mono * mono;
                    }
                    const rms = Math.sqrt(sum / left.length);
                    
                    if (rms > maxRMS) {
                        maxRMS = rms;
                    }
                    
                    if (rms > 0.001) {
                        soundPackets++;
                    }
                    
                    // Update meter
                    const percent = Math.min(100, rms * 1000);
                    document.getElementById('bar').style.width = percent + '%';
                    document.getElementById('level').textContent = percent.toFixed(0) + '%';
                    
                    // Update status
                    if (rms > 0.01) {
                        document.getElementById('status').className = 'good';
                        document.getElementById('status').innerHTML = `‚úÖ <strong>MICROPHONE WORKING!</strong> RMS: ${rms.toFixed(4)}`;
                    } else if (rms > 0.001) {
                        document.getElementById('status').className = 'good';
                        document.getElementById('status').innerHTML = `‚úÖ Microphone working (quiet). RMS: ${rms.toFixed(4)}`;
                    } else {
                        document.getElementById('status').className = 'bad';
                        document.getElementById('status').innerHTML = `‚ùå <strong>NO SOUND DETECTED</strong> - Check microphone! RMS: ${rms.toFixed(6)}`;
                    }
                    
                    // Update info
                    const soundPercent = totalPackets > 0 ? ((soundPackets / totalPackets) * 100).toFixed(1) : 0;
                    info = document.getElementById('info').innerHTML.split('<br><br><strong>Statistics:')[0];
                    info += '<br><br><strong>Statistics:</strong><br>';
                    info += `Total packets: ${totalPackets}<br>`;
                    info += `Packets with sound: ${soundPackets} (${soundPercent}%)<br>`;
                    info += `Max RMS: ${maxRMS.toFixed(6)}<br>`;
                    info += `Current RMS: ${rms.toFixed(6)}<br>`;
                    document.getElementById('info').innerHTML = info;
                };
                
                // Connect audio graph
                source.connect(analyser);
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                document.getElementById('status').className = 'good';
                document.getElementById('status').innerHTML = '‚úÖ <strong>Test started! Speak into your microphone...</strong>';
                
            } catch (err) {
                document.getElementById('status').className = 'bad';
                document.getElementById('status').innerHTML = `‚ùå <strong>Error:</strong> ${err.message}`;
                console.error(err);
            }
        }

        function stopTest() {
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            if (source) {
                source.disconnect();
                source = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            
            document.getElementById('bar').style.width = '0%';
            document.getElementById('level').textContent = '0%';
            document.getElementById('status').innerHTML = '‚èπ Test stopped';
            document.getElementById('status').className = '';
        }
    </script>
</body>
</html>

