import{i as Ne,P as $e,a as U,r as o,ak as le,_,al as Le,j as s,am as ce,an as Me,ao as Fe,ap as de}from"./index-9DSA42Q2.js";import{C as P}from"./CustomDropdown-DqAXTwZC.js";import{D as Pe}from"./DataTable-AM5dFNtq.js";import{C as qe}from"./ContextMenu-Xdes_WnF.js";import"./index-BUMpm_8V.js";const Be=({onTitleChange:q})=>{const A=Ne(),i=$e(),N=U(e=>e.search?.searchTerm||"");o.useEffect(()=>{},[N]);const{slots:C,loading:$,error:B}=U(e=>e.interviewSlots??{slots:[],loading:!1,error:null}),h=U(e=>e?.user?.user||e?.user?.currentUser||{}),[ue,Q]=o.useState(!0),[me]=o.useState(0),[T,k]=o.useState(!1),[K,fe]=o.useState(null),[x,W]=o.useState(new Date),[I,L]=o.useState([]),[he,H]=o.useState(0),[D,pe]=o.useState(!1),[we,G]=o.useState(!1),[J,ge]=o.useState([]),[w,X]=o.useState(null),[Y,V]=o.useState(!1),[z,O]=o.useState([]),[j,Z]=o.useState(null),[ee,te]=o.useState(!1),[E,se]=o.useState({visible:!1,x:0,y:0,rowData:null,rowIndex:null}),[be,ne]=o.useState(null),[ye,ae]=o.useState(null),Se=o.useMemo(()=>{if(!C||C.length===0)return[];if(!N)return[...C].sort((t,a)=>t.interview_date&&a.interview_date?new Date(a.interview_date)-new Date(t.interview_date):0);const e=N.toLowerCase();return[...C].sort((t,a)=>{const n=r=>{let f=0;const p=(g,b="")=>{Object.entries(g||{}).forEach(([y,l])=>{if(l==null)return;let c;if(typeof l=="object"&&l!==null){p(l,`${b}${y}.`);return}else typeof l=="boolean"?c=l?"true":"false":typeof l=="number"?c=String(l):l instanceof Date?c=l.toLocaleDateString()+" "+l.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):c=String(l);const F=c.toLowerCase();F.includes(e)&&(F.startsWith(e)?f+=10:f+=5)})};return p(r),f},d=n(t),m=n(a);return m!==d?m-d:t.interview_date&&a.interview_date?new Date(a.interview_date)-new Date(t.interview_date):0})},[C,N]),[u,S]=o.useState(()=>({ai_interview_type:"technical",difficulty_level:"intermediate",question_count:10,time_limit:"10",topics:"",max_candidates:"1",job:"",company:""})),R=o.useCallback(()=>{W(new Date),L([]),S({ai_interview_type:"technical",difficulty_level:"intermediate",question_count:10,time_limit:"10",topics:"",max_candidates:"1",job:"",company:""})},[]),ve=o.useCallback(async()=>{Q(!0);try{if(!localStorage.getItem("authToken"))throw new Error("No authentication token found");const t=await A(le());le.fulfilled.match(t)||i.error(t.error.message||"Failed to load interview slots")}catch(e){i.error(e.message||"An error occurred while loading slots")}finally{Q(!1)}},[A,i]),oe=o.useCallback(async e=>{if(!e){O([]);return}te(!0);try{const t=localStorage.getItem("authToken");if(!t)throw new Error("Authentication token not found");const a=await fetch(`${_}/api/jobs/?company_id=${e}`,{headers:{"Content-Type":"application/json",Authorization:`Token ${t}`}});if(!a.ok)throw new Error(`Failed to fetch jobs: ${a.status}`);const n=await a.json(),d=n.results||n;Array.isArray(d)&&d.length===0&&i.info("No jobs found for this company"),O(Array.isArray(d)?d:[])}catch{console.error("Error fetching jobs"),i.error("Failed to fetch jobs"),O([])}finally{te(!1)}},[i]),_e=o.useCallback(async()=>{if(h?.role?.toLowerCase()==="admin"){V(!0);try{const e=localStorage.getItem("authToken");if(!e)throw new Error("Authentication token not found");const t=await fetch(`${_}/api/companies/`,{headers:{"Content-Type":"application/json",Authorization:`Token ${e}`}});if(!t.ok)throw new Error(`Failed to fetch companies: ${t.status}`);const a=await t.json(),n=a.results||a;ge(Array.isArray(n)?n:[])}catch{console.error("Error fetching companies"),i.error("Failed to fetch companies")}finally{V(!1)}}},[h?.role,i]);o.useEffect(()=>{if(h&&Object.keys(h).length>0){if(ve(),_e(),h.role?.toLowerCase()==="company"){const e=h.id||h.company_id;X(e),oe(e)}}else i.error("Please log in to access interview scheduling.")},[h]),o.useEffect(()=>{h?.role?.toLowerCase()==="admin"&&w&&(oe(w),Z(null))},[w,h?.role]);const xe=(e,t,a)=>{e.preventDefault(),e.stopPropagation(),se({visible:!0,x:e.clientX,y:e.clientY,rowData:t,rowIndex:a})},je=(e,t,a)=>{e==="edit"?(ne(a),ae({...t})):e==="delete"&&re(t.id)},Ce=()=>{se({visible:!1,x:0,y:0,rowData:null,rowIndex:null})},v=o.useCallback(async(e=!1)=>{if(!(($||T)&&!e))try{const t=localStorage.getItem("authToken");if(!t)throw new Error("Authentication token not found");const a=JSON.parse(localStorage.getItem("user")||"{}"),n=a?.company_id||a?.id;let d=`${_}/api/interviews/slots/`;n&&(d+=`${d.includes("?")?"&":"?"}company_id=${n}`);const m=await fetch(d,{headers:{"Content-Type":"application/json",Authorization:`Token ${t}`}});if(!m.ok)throw new Error(`Failed to fetch slots: ${m.status} ${m.statusText}`);const r=await m.json(),f=r.results||r,p=Array.isArray(f)?f:[];return A(Le(p)),e&&i.success("Interview slots refreshed successfully!"),G(!1),p}catch(t){throw i.error(t.message||"Failed to fetch slots"),t}},[$,T,A,i]),Te=o.useCallback(e=>{W(e),L([])},[]),ke=o.useCallback((e,t)=>{L(e),t&&S(a=>({...a,time_limit:t}))},[]),ie=o.useCallback((e,t,a)=>{if(!e)return"";const[n,d]=e.split(":").map(Number),m=new Date(a);m.setHours(n,d+t,0,0);const r=String(m.getHours()).padStart(2,"0"),f=String(m.getMinutes()).padStart(2,"0");return`${r}:${f}`},[]),Ie=o.useCallback(async e=>{if(e&&e.preventDefault(),I.length===0){i.error("Please select at least one time slot");return}if(!u.ai_interview_type){i.error("Please select an interview type");return}if(!u.difficulty_level){i.error("Please select a difficulty level");return}if(h?.role?.toLowerCase()==="admin"&&!w){i.error("Please select a company");return}if(!j){i.error("Please select a job");return}try{k(!0);const t=localStorage.getItem("authToken");if(!t)throw new Error("Authentication token not found");console.log("ðŸ‘¤ User data:",h),console.log("ðŸ¢ User company_id:",h?.company_id),console.log("ðŸ†” User id:",h?.id),console.log("ðŸŽ¯ Selected company ID:",w),console.log("ðŸ“‹ Available companies:",J),console.log("ðŸ’¼ Selected job ID:",j),console.log("ðŸ“‹ Available jobs:",z);const a=x.toISOString().split("T")[0];if(I.length>0){const n=[...I].sort();let d,m;const r=n[0],f=n[n.length-1];r.includes("-")?d=r.split("-")[0]:d=r,f.includes("-")?m=f.split("-")[1]:m=ie(f,10,x);const p=c=>c&&(c.includes(":")&&c.split(":").length===2?`${c}:00`:c),g=u.question_count?typeof u.question_count=="number"?u.question_count:parseInt(u.question_count,10):10,b=g>=1&&g<=20?g:10,y={interview_date:a,start_time:p(d),end_time:p(m),ai_interview_type:u.ai_interview_type||"technical",ai_configuration:{difficulty_level:u.difficulty_level||"intermediate",question_count:b,time_limit:parseInt(u.time_limit)||10,topics:u.topics?u.topics.split(",").map(c=>c.trim()):["algorithms","data_structures"]},max_candidates:parseInt(u.max_candidates)||1,status:u.status||"available",job:j||null,company:w||null};console.log("ðŸ“Š Question Count being sent:",b),console.log("ðŸ“Š Full ai_configuration:",y.ai_configuration),console.log("ðŸš€ Sending slot data:",y);const l=await fetch(`${_}/api/interviews/slots/`,{method:"POST",headers:{Authorization:`Token ${t}`,"Content-Type":"application/json"},body:JSON.stringify(y)});if(!l.ok){const c=await l.json();throw console.error("âŒ API Error Response:",c),console.error("âŒ Response Status:",l.status),new Error(`Failed to create slot: ${JSON.stringify(c)}`)}await v(),H(c=>c+1),L([]),R(),i.success("Interview slot created successfully!")}}catch{i.error("Failed to create slot")}finally{k(!1)}},[I,x,u,h,v,R,ie,i,J,w,j,z]),re=o.useCallback(async e=>{if(window.confirm("Are you sure you want to delete this slot?"))try{k(!0);const t=localStorage.getItem("authToken");if(!t)throw new Error("Authentication token not found");if(!(await fetch(`${_}/api/interviews/slots/${e}/`,{method:"DELETE",headers:{Authorization:`Token ${t}`}})).ok)throw new Error("Failed to delete slot");await v(),i.success("Interview slot deleted successfully!")}catch{i.error("Failed to delete slot")}finally{k(!1)}},[v,i]),De=o.useCallback(async e=>{try{let t=function(r){try{const f=r.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);if(!f)return r;let p=parseInt(f[1]);const g=parseInt(f[2]),b=f[3].toUpperCase();b==="AM"&&p===12?p=0:b==="PM"&&p!==12&&(p+=12);const y=p.toString().padStart(2,"0"),l=g.toString().padStart(2,"0");return`${y}:${l}:00`}catch{return r}};const a=localStorage.getItem("authToken");if(!a)throw new Error("Authentication token not found");let n={...e};if(n.start_time&&n.start_time.includes("M")&&(n.start_time=t(n.start_time)),n.end_time&&n.end_time.includes("M")&&(n.end_time=t(n.end_time)),n.start_time&&n.end_time)try{const r=n.start_time.split(":"),f=n.end_time.split(":"),p=parseInt(r[0]),g=parseInt(r[1]),b=parseInt(f[0]),y=parseInt(f[1]),l=p*60+g,c=b*60+y;if(l>=c)throw new Error("End time must be after start time");if(l<480||c>1320){const Ee=new Date(2e3,0,1,p,g).toLocaleTimeString([],{hour:"numeric",minute:"2-digit",hour12:!0}),Ae=new Date(2e3,0,1,b,y).toLocaleTimeString([],{hour:"numeric",minute:"2-digit",hour12:!0});throw new Error(`Interview time (${Ee} - ${Ae}) must be between 8:00 AM and 10:00 PM.`)}}catch{throw new Error('Invalid time format. Please use format like "9:30 AM" or "2:15 PM"')}const d={interview_date:n.interview_date,start_time:n.start_time,end_time:n.end_time,ai_interview_type:n.ai_interview_type,status:n.status,max_candidates:n.max_candidates,ai_configuration:n.ai_configuration,job:n.job,company:n.company,slot_type:n.slot_type,notes:n.notes,is_recurring:n.is_recurring,recurring_pattern:n.recurring_pattern},m=await fetch(`${_}/api/interviews/slots/${e.id}/`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Token ${a}`},body:JSON.stringify(d)});if(!m.ok){const r=await m.json().catch(()=>({}));throw new Error(r.detail||r.message||JSON.stringify(r)||`HTTP error! status: ${m.status}`)}await v(),H(r=>r+1),setTimeout(()=>{},100)}catch{throw new Error("Failed to update slot")}},[v]),M=o.useCallback(e=>{if(!e)return"";const[t,a]=e.split(":"),n=parseInt(t,10),d=n>=12?"PM":"AM";return`${n%12||12}:${a} ${d}`},[]);return o.useEffect(()=>{q&&q("Talaro Interview Manager")},[q]),ue?s.jsxs("div",{className:"ai-int-interview-scheduler-loading",children:[s.jsx(ce,{color:"#4f46e5"}),s.jsx("p",{children:"Loading Management System..."})]}):(B&&me===0&&!we&&(i.error(B,"Failed to Load Slots"),G(!0)),s.jsxs("div",{className:"ai-interview-scheduler",children:[s.jsx("div",{className:"mobile-form-toggle",children:s.jsxs("button",{className:`mobile-create-slot-btn ${D?"form-open":""}`,onClick:()=>pe(!D),children:[s.jsx("span",{className:"btn-icon",children:D?"Ã—":"+"}),s.jsx("span",{className:"btn-text",children:D?"Close":"Create New Slot"})]})}),s.jsx("div",{className:`ai-int-form-container slide-in-left ${D?"mobile-form-visible":"mobile-form-hidden"}`,children:s.jsxs("form",{className:"ai-int-form",onSubmit:Ie,children:[s.jsx("h3",{className:"ai-int-form-title",children:"Interview Scheduler"}),s.jsxs("div",{className:"ai-int-form-group",children:[s.jsx("label",{children:"Date"}),s.jsx(Me,{selectedDate:x,onSelectDate:Te,isDateFullyBooked:()=>!1})]}),s.jsxs("div",{className:"ai-int-form-group",children:[s.jsx("label",{children:"Time Slots"}),x&&s.jsx(Fe,{selectedTimes:I,onSelectTimes:ke,selectedDate:x,baseURL:_,isBooking:T,setIsBooking:k,aiInterviewType:u.ai_interview_type})]}),s.jsxs("div",{className:"ai-int-form-group",children:[s.jsx("label",{children:"Interview Type"}),s.jsx(P,{value:u.ai_interview_type,options:[{value:"",label:"Select interview type"},{value:"technical",label:"Technical"},{value:"behavioral",label:"Behavioral"},{value:"system-design",label:"System Design"}],onChange:e=>S(t=>({...t,ai_interview_type:e})),placeholder:"Select interview type"})]}),s.jsxs("div",{className:"ai-int-form-group",children:[s.jsx("label",{children:"Difficulty Level"}),s.jsx(P,{value:u.difficulty_level,options:[{value:"",label:"Select difficulty level"},{value:"easy",label:"Easy"},{value:"intermediate",label:"Intermediate"},{value:"hard",label:"Hard"}],onChange:e=>S(t=>({...t,difficulty_level:e})),placeholder:"Select difficulty level"})]}),s.jsxs("div",{className:"ai-int-form-group",children:[s.jsx("label",{children:"Question Count"}),s.jsx("input",{type:"number",min:"1",max:"20",value:u.question_count,placeholder:"Enter number of questions (1-20)",onChange:e=>{const t=e.target.value;if(t==="")S(a=>({...a,question_count:""}));else{const a=parseInt(t,10);!isNaN(a)&&a>=1&&a<=20&&S(n=>({...n,question_count:a}))}},onBlur:e=>{const t=e.target.value;(t===""||isNaN(parseInt(t,10))||parseInt(t,10)<1)&&S(a=>({...a,question_count:10}))}})]}),s.jsxs("div",{className:"ai-int-form-group",children:[s.jsx("label",{children:"Topics (comma separated)"}),s.jsx("input",{type:"text",value:u.topics,onChange:e=>S(t=>({...t,topics:e.target.value})),placeholder:"e.g., algorithms, data structures, system design"})]}),s.jsxs("div",{className:"ai-int-form-group",children:[s.jsx("label",{children:"Max Candidates"}),s.jsx("input",{type:"number",min:"1",value:u.max_candidates,placeholder:"Enter maximum number of candidates",onChange:e=>S(t=>({...t,max_candidates:parseInt(e.target.value)||0}))})]}),h?.role?.toLowerCase()==="admin"&&s.jsxs("div",{className:"ai-int-form-group",children:[s.jsx("label",{children:"Company"}),s.jsx(P,{value:w?String(w):"",options:[{value:"",label:"Select a company"},...J.map(e=>({value:String(e.id),label:e.name||e.company_name||`Company ${e.id}`}))],onChange:e=>X(e?parseInt(e):null),placeholder:"Select a company",disabled:Y,searchable:!0,openAbove:!0}),Y&&s.jsx("small",{children:"Loading companies..."})]}),s.jsxs("div",{className:"ai-int-form-group",children:[s.jsx("label",{children:"Job"}),s.jsx(P,{value:j?String(j):"",options:[{value:"",label:"Select a job"},...z.map(e=>({value:String(e.id),label:e.title||e.job_title||`Job ${e.id}`}))],onChange:e=>Z(e?parseInt(e):null),placeholder:"Select a job",disabled:ee||h?.role?.toLowerCase()==="admin"&&!w,searchable:!0,openAbove:!0}),ee&&s.jsx("small",{children:"Loading jobs..."}),h?.role?.toLowerCase()==="admin"&&!w&&s.jsx("small",{style:{color:"var(--color-muted)"},children:"Please select a company first"})]}),s.jsxs("div",{className:"ai-int-form-actions",children:[s.jsx("button",{type:"submit",className:"ai-int-btn ai-int-btn-primary",disabled:T||$,children:T?s.jsx(ce,{size:8,color:"#fff"}):K?"Update Slot":"Create Slot"}),K&&s.jsx("button",{type:"button",className:"ai-int-btn ai-int-btn-secondary",onClick:()=>{fe(null),R()},children:"Cancel"})]})]})}),s.jsxs("div",{className:"ai-int-table-container slide-in-right",children:[s.jsx(Pe,{title:"Interview Slots",columns:[{field:"interview_date",header:"Date",width:"8%",type:"date",editable:!0,render:e=>e?new Date(e).toLocaleDateString():"N/A"},{field:"start_time",header:"Start Time",width:"9%",type:"time12",editable:!0,render:e=>!e||typeof e!="string"?"N/A":M(e),formatForEdit:e=>!e||typeof e!="string"?"":M(e),parseFromEdit:e=>e?de(e):""},{field:"end_time",header:"End Time",width:"9%",type:"time12",editable:!0,render:e=>!e||typeof e!="string"?"N/A":M(e),formatForEdit:e=>!e||typeof e!="string"?"":M(e),parseFromEdit:e=>e?de(e):""},{field:"ai_interview_type",header:"Type",width:"18%",type:"select",editable:!0,options:[{value:"technical",label:"Technical Interview"},{value:"behavioral",label:"Behavioral Interview"},{value:"coding",label:"Coding Interview"},{value:"system_design",label:"System Design Interview"},{value:"general",label:"General Interview"}]},{field:"status",header:"Status",width:"15%",type:"select",editable:!0,options:[{value:"available",label:"Available"},{value:"booked",label:"Booked"},{value:"cancelled",label:"Cancelled"},{value:"completed",label:"Completed"}],render:e=>s.jsx("span",{className:"status-cell","data-status":e?.toLowerCase(),children:e})},{field:"max_candidates",header:"Max",width:"8%",type:"number",editable:!0,render:e=>e||1},{field:"job_title",header:"Job",width:"8%",editable:!1},{field:"created_at",header:"Created",width:"8%",editable:!1,render:e=>e?new Date(e).toLocaleDateString():"N/A"},{field:"updated_at",header:"Updated",width:"8%",editable:!1,render:e=>e?new Date(e).toLocaleDateString():"N/A"}],data:Se,loading:$,actions:["edit","delete"],onAction:(e,t)=>{e!=="edit"&&e==="delete"&&re(t.id)},onContextMenuClick:xe,onEdit:async e=>{await De(e)},editingRow:be,editingData:ye,setEditingRow:ne,setEditingData:ae,showRefresh:!0,onRefresh:async()=>{try{await v(!0),H(e=>e+1)}catch{i.error("Failed to refresh interview slots. Please try again.")}},showActions:!0,defaultPageSize:10,pageSizeOptions:[10,20,50,100]},`slots-table-${he}`),s.jsx(qe,{visible:E.visible,x:E.x,y:E.y,actions:["edit","delete"],onAction:je,onClose:Ce,rowData:E.rowData,rowIndex:E.rowIndex})]})]}))};export{Be as default};
