<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Interview Report - {{ session.id }}</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
        }
        body {
            font-family: sans-serif;
            font-size: 11px;
            color: #333;
        }
        h1, h2, h3, h4, h5 {
            color: #333;
            font-weight: bold;
        }
        h1 {
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 20px;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 5px;
            page-break-inside: avoid; /* Tries to keep sections from splitting across pages */
        }
        pre {
            white-space: pre-wrap;
            font-family: monospace; /* Use a monospace font for code and logs */
            font-size: 9px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .chart-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .chart-container img {
            max-width: 400px;
        }
        ul {
            padding-left: 20px;
        }
        .question-block {
            page-break-inside: avoid;
            margin-bottom: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .question-block:first-child {
            border-top: none;
            padding-top: 0;
        }
        .follow-up-question {
            border-left: 3px solid #ccc;
            padding-left: 10px;
            margin-left: 15px;
            margin-top: 10px;
        }
        .answer {
            font-style: italic;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Interview Report</h1>
    <p><strong>Candidate:</strong> {{ session.candidate_name }}</p>
    <p><strong>Session ID:</strong> {{ session.id }}</p>
    <p><strong>Date:</strong> {{ session.created_at }}</p>

    {% if session.is_evaluated and session.language_code == 'en' %}
        <div class="section">
            <h2>Overall Candidate Profile</h2>
            <pre>{{ session.overall_performance_feedback|default:"Evaluation not available." }}</pre>
        </div>
        <div class="section">
            <h2>AI Evaluation: Resume vs. Job Description</h2>
            <pre>{{ session.resume_feedback|default:"Evaluation not available." }}</pre>
        </div>
        <div class="section">
            <h2>AI Evaluation: Interview Performance</h2>
            <pre>{{ session.answers_feedback|default:"Evaluation not available." }}</pre>
        </div>
    {% endif %}

    <div class="section">
        <h2>Proctoring Warnings Summary</h2>
        {% if warning_counts %}
            <div class="chart-container">
                <img src="{{ chart_url }}" alt="Proctoring Warnings Chart">
            </div>
            <ul>
                {% for warning, count in warning_counts.items %}
                    <li>{{ warning }}: {{ count }} instance(s)</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No warnings were logged during this session.</p>
        {% endif %}
    </div>

    <div class="section">
        <h2>Questions and Transcribed Answers</h2>
        {% for main_question in main_questions_with_followups %}
            {% if main_question.question_type != 'CODING' %}
                <div class="question-block">
                    <h4>Q{{ main_question.order|add:1 }}: {{ main_question.question_text }}</h4>
                    <p class="answer"><strong>Answer:</strong> {{ main_question.transcribed_answer|default:"No answer recorded." }}</p>
                    
                    {% for follow_up in main_question.follow_ups.all %}
                        <div class="follow-up-question">
                            <h5>Follow-Up: {{ follow_up.question_text }}</h5>
                            <p class="answer"><strong>Answer:</strong> {{ follow_up.transcribed_answer|default:"No answer recorded." }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- === NEW SECTION FOR CODING CHALLENGE SUBMISSIONS === -->
    {% if code_submissions %}
    <div class="section">
        <h2>Coding Challenge Submission(s)</h2>
        {% for submission in code_submissions %}
            <div class="question-block">
                <h4>Challenge: {{ submission.question.question_text }}</h4>
                <p class="answer"><strong>Language:</strong> {{ submission.language }}</p>
                <p><strong>Submitted Code:</strong></p>
                <pre>{{ submission.submitted_code|default:"No code was submitted." }}</pre>
                
                <p style="margin-top:15px;"><strong>Test Results & Output:</strong></p>
                <pre>{{ submission.output_log|default:"Test results were not recorded." }}</pre>
            </div>
        {% endfor %}
    </div>
    {% endif %}
    <!-- === END OF NEW SECTION === -->

</body>
</html>