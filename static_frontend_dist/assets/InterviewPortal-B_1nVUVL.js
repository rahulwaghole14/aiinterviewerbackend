import{r as s,j as e,am as g,_ as k,aB as G,h as J}from"./index-DasKWjZg.js";import{y}from"./index-C68axRq4.js";const W=({sessionData:p,onComplete:f,onError:c})=>{const[d,a]=s.useState("camera-setup"),[w,j]=s.useState(null),[b,u]=s.useState(!1),[t,l]=s.useState(!1),[h,o]=s.useState(null),v=s.useRef(null),I=s.useRef(null);s.useEffect(()=>(C(),()=>{w&&w.getTracks().forEach(n=>n.stop())}),[]);const C=async()=>{try{l(!0),o(null);const n=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:"user"},audio:!1});j(n),v.current&&(v.current.srcObject=n,v.current.onloadedmetadata=()=>{u(!0),a("id-verification")})}catch(n){console.error("Camera setup error:",n),n.name==="NotAllowedError"?o("Camera access is required for ID verification. Please allow camera access and refresh the page."):n.name==="NotFoundError"?o("No camera found. Please connect a camera and refresh the page."):o("Failed to access camera. Please check your device and refresh the page.")}finally{l(!1)}},S=()=>{if(!v.current||!I.current)return null;const n=v.current,x=I.current,P=x.getContext("2d");return x.width=n.videoWidth,x.height=n.videoHeight,P.drawImage(n,0,0,x.width,x.height),new Promise(E=>{x.toBlob(E,"image/jpeg",.8)})},i=async()=>{try{l(!0);const n=await S();await new Promise(x=>setTimeout(x,2e3)),a("ready"),y.success("ID verification completed successfully!"),setTimeout(()=>{f()},2e3)}catch(n){console.error("ID verification error:",n),o("Failed to verify ID. Please try again."),y.error("ID verification failed. Please try again.")}finally{l(!1)}},N=()=>{o(null),a("camera-setup"),C()};return d==="camera-setup"?e.jsx("div",{className:"interview-id-verification",children:e.jsxs("div",{className:"verification-container",children:[e.jsxs("div",{className:"verification-header",children:[e.jsx("h2",{children:"Camera Setup"}),e.jsx("p",{children:"Please allow camera access to continue with ID verification"})]}),t?e.jsxs("div",{className:"camera-loading",children:[e.jsx(g,{color:"var(--color-primary)",size:15}),e.jsx("p",{children:"Setting up camera..."})]}):h?e.jsxs("div",{className:"camera-error",children:[e.jsx("div",{className:"error-icon",children:"ðŸ“·"}),e.jsx("p",{children:h}),e.jsx("button",{className:"retry-button",onClick:N,children:"Retry Camera Setup"})]}):e.jsxs("div",{className:"camera-preview",children:[e.jsx("video",{ref:v,autoPlay:!0,muted:!0,playsInline:!0,className:"camera-video"}),e.jsx("p",{children:"Camera is ready!"})]})]})}):d==="id-verification"?e.jsx("div",{className:"interview-id-verification",children:e.jsxs("div",{className:"verification-container",children:[e.jsxs("div",{className:"verification-header",children:[e.jsx("h2",{children:"ID Verification"}),e.jsx("p",{children:'Please position your face in the camera and click "Verify ID"'})]}),e.jsxs("div",{className:"verification-content",children:[e.jsxs("div",{className:"camera-preview",children:[e.jsx("video",{ref:v,autoPlay:!0,muted:!0,playsInline:!0,className:"camera-video"}),e.jsx("div",{className:"face-overlay",children:e.jsx("div",{className:"face-frame"})})]}),e.jsxs("div",{className:"verification-instructions",children:[e.jsx("h3",{children:"Instructions:"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Ensure your face is clearly visible"}),e.jsx("li",{children:"Remove any hats or sunglasses"}),e.jsx("li",{children:"Look directly at the camera"}),e.jsx("li",{children:"Ensure good lighting"})]})]}),e.jsx("div",{className:"verification-actions",children:e.jsx("button",{className:"verify-button",onClick:i,disabled:t,children:t?e.jsxs(e.Fragment,{children:[e.jsx(g,{color:"#ffffff",size:8}),e.jsx("span",{children:"Verifying..."})]}):"Verify ID"})})]}),e.jsx("canvas",{ref:I,style:{display:"none"}})]})}):d==="ready"?e.jsx("div",{className:"interview-id-verification",children:e.jsxs("div",{className:"verification-container",children:[e.jsxs("div",{className:"verification-header",children:[e.jsx("h2",{children:"Ready to Start!"}),e.jsx("p",{children:"ID verification completed successfully"})]}),e.jsxs("div",{className:"ready-content",children:[e.jsx("div",{className:"success-icon",children:"âœ…"}),e.jsx("h3",{children:"You're all set!"}),e.jsx("p",{children:"Your interview will begin in a moment..."}),e.jsx("div",{className:"loading-indicator",children:e.jsx(g,{color:"var(--color-primary)",size:10})})]})]})}):null},H=({sessionData:p,mediaStream:f,onComplete:c,onError:d})=>{const[a,w]=s.useState(null),[j,b]=s.useState([]),[u,t]=s.useState(0),[l,h]=s.useState(!1),[o,v]=s.useState(!1),[I,C]=s.useState(""),[S,i]=s.useState(!1),[N,n]=s.useState(null),[x,P]=s.useState("loading"),E=s.useRef(null),T=s.useRef([]),D=s.useRef(null),_=s.useRef(null),F=s.useRef(null);s.useEffect(()=>{L()},[]),s.useEffect(()=>()=>{E.current&&E.current.stop(),D.current&&D.current.close()},[]);const L=async()=>{try{i(!0);const r=await fetch(`${k}/interview_app/get_questions/?session_id=${p.session_id}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error("Failed to load interview questions");const m=await r.json();if(b(m.questions||[]),m.questions&&m.questions.length>0)w(m.questions[0]),P("question");else throw new Error("No questions available for this interview")}catch(r){console.error("Interview initialization error:",r),n(r.message),d(r.message)}finally{i(!1)}},M=async r=>{try{v(!0),_.current&&(_.current.src=r.audio_url,await _.current.play(),_.current.onended=()=>{v(!1),q()})}catch(m){console.error("Error playing audio:",m),v(!1),q()}},q=()=>{P("answering"),F.current=Date.now(),A()},A=()=>{if(!f){y.error("No microphone access available");return}try{T.current=[];const r=new MediaRecorder(f,{mimeType:"audio/webm;codecs=opus"});E.current=r,r.ondataavailable=m=>{m.data.size>0&&T.current.push(m.data)},r.onstop=async()=>{await $()},r.start(),h(!0)}catch(r){console.error("Recording error:",r),y.error("Failed to start recording")}},Y=()=>{E.current&&l&&(E.current.stop(),h(!1))},$=async()=>{try{i(!0);const r=new Blob(T.current,{type:"audio/webm"}),m=(Date.now()-F.current)/1e3,R=new FormData;R.append("audio_data",r),R.append("session_id",p.session_id),R.append("question_id",a.id),R.append("response_time",m.toString());const Q=await fetch(`${k}/interview_app/transcribe_audio/`,{method:"POST",body:R});if(!Q.ok)throw new Error("Failed to transcribe audio");const z=await Q.json();C(z.text||""),await O(z.text,m),setTimeout(()=>{U()},2e3)}catch(r){console.error("Processing error:",r),y.error("Failed to process your answer. Please try again.")}finally{i(!1)}},O=async(r,m)=>{try{(await fetch(`${k}/interview_app/save_answer/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:p.session_id,question_id:a.id,transcribed_answer:r,response_time_seconds:m})})).ok||console.error("Failed to save answer")}catch(R){console.error("Save answer error:",R)}},U=()=>{const r=u+1;r<j.length?(t(r),w(j[r]),C(""),P("question")):V()},V=async()=>{try{i(!0),(await fetch(`${k}/interview_app/end_interview_session/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:p.session_id})})).ok||console.error("Failed to end interview session"),P("complete"),c()}catch(r){console.error("Complete interview error:",r)}finally{i(!1)}},B=()=>{a.audio_url?M(a):q()};return S&&x==="loading"?e.jsx("div",{className:"interview-session",children:e.jsxs("div",{className:"session-loading",children:[e.jsx(g,{color:"var(--color-primary)",size:15}),e.jsx("h2",{children:"Preparing Your Interview..."}),e.jsx("p",{children:"Please wait while we load your interview questions."})]})}):N?e.jsx("div",{className:"interview-session",children:e.jsxs("div",{className:"session-error",children:[e.jsx("div",{className:"error-icon",children:"âš ï¸"}),e.jsx("h2",{children:"Interview Error"}),e.jsx("p",{children:N}),e.jsx("button",{className:"retry-button",onClick:()=>window.location.reload(),children:"Retry Interview"})]})}):x==="question"?e.jsx("div",{className:"interview-session",children:e.jsxs("div",{className:"session-container",children:[e.jsxs("div",{className:"session-header",children:[e.jsxs("div",{className:"progress-indicator",children:["Question ",u+1," of ",j.length]}),e.jsxs("div",{className:"session-info",children:[e.jsx("h2",{children:"Talaro Interview"}),e.jsx("p",{children:"Listen to the question and prepare your answer"})]})]}),e.jsxs("div",{className:"question-content",children:[e.jsxs("div",{className:"question-display",children:[e.jsx("h3",{children:"Question:"}),e.jsx("p",{children:a.question})]}),e.jsx("div",{className:"question-actions",children:e.jsx("button",{className:"start-question-button",onClick:B,disabled:o,children:o?e.jsxs(e.Fragment,{children:[e.jsx(g,{color:"#ffffff",size:8}),e.jsx("span",{children:"Playing Question..."})]}):"Start Question"})})]}),e.jsx("audio",{ref:_,style:{display:"none"}})]})}):x==="answering"?e.jsx("div",{className:"interview-session",children:e.jsxs("div",{className:"session-container",children:[e.jsxs("div",{className:"session-header",children:[e.jsxs("div",{className:"progress-indicator",children:["Question ",u+1," of ",j.length]}),e.jsxs("div",{className:"session-info",children:[e.jsx("h2",{children:"Recording Your Answer"}),e.jsx("p",{children:"Speak clearly into your microphone"})]})]}),e.jsxs("div",{className:"answering-content",children:[e.jsx("div",{className:"recording-status",children:e.jsx("div",{className:`recording-indicator ${l?"active":""}`,children:l?"ðŸ”´ Recording...":"â¹ï¸ Stopped"})}),e.jsxs("div",{className:"question-display",children:[e.jsx("h3",{children:"Question:"}),e.jsx("p",{children:a.question})]}),e.jsx("div",{className:"answer-controls",children:e.jsx("button",{className:"stop-recording-button",onClick:Y,disabled:!l||S,children:S?e.jsxs(e.Fragment,{children:[e.jsx(g,{color:"#ffffff",size:8}),e.jsx("span",{children:"Processing..."})]}):"Stop Recording"})}),I&&e.jsxs("div",{className:"transcription-display",children:[e.jsx("h3",{children:"Your Answer:"}),e.jsx("p",{children:I})]})]})]})}):null},K=({sessionData:p,onClose:f})=>{const[c,d]=s.useState(!1),[a,w]=s.useState(null);s.useEffect(()=>{(()=>{navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(l=>{l.getTracks().forEach(h=>h.stop())}).catch(()=>{})})(),j()},[]);const j=async()=>{try{d(!0),await new Promise(t=>setTimeout(t,1e3)),w({totalQuestions:5,completedQuestions:5,duration:"15 minutes",status:"completed"})}catch(t){console.error("Error fetching completion data:",t)}finally{d(!1)}},b=()=>{try{window.opener?window.close():window.location.href="/interview-complete"}catch(t){console.error("Error closing interview:",t),y.info("Interview completed! You can now close this tab.")}},u=async()=>{try{d(!0);const t=await fetch(`${k}/interview_app/report/${p.session_id}/`,{method:"GET",headers:{"Content-Type":"application/json"}});if(t.ok){const l=await t.blob(),h=window.URL.createObjectURL(l),o=document.createElement("a");o.href=h,o.download=`interview-report-${p.session_id}.pdf`,document.body.appendChild(o),o.click(),window.URL.revokeObjectURL(h),document.body.removeChild(o),y.success("Interview report downloaded successfully!")}else throw new Error("Failed to download report")}catch(t){console.error("Download error:",t),y.error("Failed to download interview report. Please try again later.")}finally{d(!1)}};return c&&!a?e.jsx("div",{className:"interview-complete",children:e.jsxs("div",{className:"completion-loading",children:[e.jsx(g,{color:"var(--color-primary)",size:15}),e.jsx("h2",{children:"Completing Interview..."}),e.jsx("p",{children:"Please wait while we finalize your interview session."})]})}):e.jsx("div",{className:"interview-complete",children:e.jsxs("div",{className:"completion-container",children:[e.jsxs("div",{className:"completion-header",children:[e.jsx("div",{className:"success-icon",children:"ðŸŽ‰"}),e.jsx("h1",{children:"Interview Completed!"}),e.jsx("p",{children:"Thank you for completing your Talaro interview session."})]}),e.jsxs("div",{className:"completion-content",children:[e.jsxs("div",{className:"completion-summary",children:[e.jsx("h3",{children:"Interview Summary"}),e.jsxs("div",{className:"summary-grid",children:[e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"summary-label",children:"Total Questions:"}),e.jsx("span",{className:"summary-value",children:a?.totalQuestions||"N/A"})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"summary-label",children:"Completed:"}),e.jsx("span",{className:"summary-value",children:a?.completedQuestions||"N/A"})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"summary-label",children:"Duration:"}),e.jsx("span",{className:"summary-value",children:a?.duration||"N/A"})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"summary-label",children:"Status:"}),e.jsx("span",{className:"summary-value status-completed",children:"Completed"})]})]})]}),e.jsxs("div",{className:"completion-message",children:[e.jsx("h3",{children:"What happens next?"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Your interview responses have been recorded and analyzed"}),e.jsx("li",{children:"Our AI system will evaluate your performance"}),e.jsx("li",{children:"You will receive feedback and results via email"}),e.jsx("li",{children:"The hiring team will review your interview"})]})]}),e.jsxs("div",{className:"completion-actions",children:[e.jsx("button",{className:"download-report-button",onClick:u,disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx(g,{color:"#ffffff",size:8}),e.jsx("span",{children:"Generating Report..."})]}):"Download Interview Report"}),e.jsx("button",{className:"close-interview-button",onClick:b,children:"Close Interview"})]})]}),e.jsxs("div",{className:"completion-footer",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Important:"})," Your interview data has been securely saved. You can close this window safely."]}),e.jsx("p",{children:"If you have any questions, please contact your recruiter or the hiring team."})]})]})})},ee=()=>{const{sessionKey:p}=G();J();const[f,c]=s.useState("loading"),[d,a]=s.useState(null),[w,j]=s.useState(null),[b,u]=s.useState(null),[t,l]=s.useState(!0),h=s.useRef(null),o=s.useRef(null);s.useEffect(()=>{p&&(async()=>{try{l(!0);const N=await fetch(`${k}/interview_app/?session_key=${p}`,{method:"GET",headers:{"Content-Type":"application/json"}}),n=await N.json();N.ok?(a(n),c("id-verification")):n.status==="not_started"?(c("not_started"),u("Interview has not started yet. Please wait for your scheduled time.")):n.status==="expired"?(c("expired"),u("This interview link has expired.")):(c("error"),u(n.error||"Invalid interview link."))}catch(N){console.error("Error checking interview session:",N),c("error"),u("Failed to load interview session. Please check your internet connection.")}finally{l(!1)}})()},[p]);const v=async()=>{try{const i=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:"user"},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});return j(i),h.current&&(h.current.srcObject=i),i}catch(i){throw console.error("Error accessing media devices:",i),i.name==="NotAllowedError"?y.error("Camera and microphone access is required for this interview."):i.name==="NotFoundError"?y.error("No camera or microphone found. Please connect your devices."):y.error("Failed to access camera and microphone. Please check your device permissions."),i}},I=async()=>{try{c("interview"),await v()}catch{c("error"),u("Failed to start interview. Please refresh the page and try again.")}},C=()=>{c("complete"),w&&(w.getTracks().forEach(i=>i.stop()),j(null))},S=i=>{c("error"),u(i)};return t?e.jsx("div",{className:"interview-portal",children:e.jsx("div",{className:"interview-loading",children:e.jsxs("div",{className:"loading-content",children:[e.jsx(g,{color:"var(--color-primary)",size:15}),e.jsx("h2",{children:"Loading Interview..."}),e.jsx("p",{children:"Please wait while we prepare your interview session."})]})})}):f==="error"?e.jsx("div",{className:"interview-portal",children:e.jsx("div",{className:"interview-error",children:e.jsxs("div",{className:"error-content",children:[e.jsx("div",{className:"error-icon",children:"âš ï¸"}),e.jsx("h2",{children:"Interview Error"}),e.jsx("p",{children:b}),e.jsx("button",{className:"retry-button",onClick:()=>window.location.reload(),children:"Retry"})]})})}):f==="not_started"?e.jsx("div",{className:"interview-portal",children:e.jsx("div",{className:"interview-not-started",children:e.jsxs("div",{className:"not-started-content",children:[e.jsx("div",{className:"clock-icon",children:"â°"}),e.jsx("h2",{children:"Interview Not Started"}),e.jsx("p",{children:b}),e.jsxs("div",{className:"countdown-info",children:[e.jsx("p",{children:"Your interview will begin at the scheduled time."}),e.jsx("p",{children:"Please keep this page open and wait for the countdown to complete."})]})]})})}):f==="expired"?e.jsx("div",{className:"interview-portal",children:e.jsx("div",{className:"interview-expired",children:e.jsxs("div",{className:"expired-content",children:[e.jsx("div",{className:"expired-icon",children:"â°"}),e.jsx("h2",{children:"Interview Expired"}),e.jsx("p",{children:b}),e.jsx("p",{children:"Please contact your recruiter for a new interview link."})]})})}):e.jsxs("div",{className:"interview-portal",children:[e.jsx("video",{ref:h,autoPlay:!0,muted:!0,playsInline:!0,style:{display:"none"}}),e.jsx("audio",{ref:o,autoPlay:!0,muted:!0,playsInline:!0,style:{display:"none"}}),f==="id-verification"&&e.jsx(W,{sessionData:d,onComplete:I,onError:S}),f==="interview"&&e.jsx(H,{sessionData:d,mediaStream:w,onComplete:C,onError:S}),f==="complete"&&e.jsx(K,{sessionData:d,onClose:()=>window.close()})]})};export{ee as default};
